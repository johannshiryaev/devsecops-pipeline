name: Security Scan Pipeline

on:
  push:
    branches-ignore:
      - l10n_develop
      - gh-pages
    tags-ignore:
      - '*'
  pull_request:
    types:
      - opened
      - synchronize

env:
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  SONAR_ORG: your_organization_key
  PROJECT_KEY: juice-shop-devsecops

jobs:
  security-check:
    runs-on: ubuntu-latest
    container: ubuntu

    services:
      juice-shop:
        image: bkimminich/juice-shop
        ports:
          - "3000:3000"
      docker:
        image: docker:dind
        options: --privileged

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Set up Docker CLI
        run: |
          apt-get update
          apt-get install -y docker.io
          systemctl start docker

      - name: "Run Gitleaks scan"
        run: |
          docker run --rm -v $(pwd):/src ghcr.io/gitleaks/gitleaks detect --source /src --no-git --verbose

      - name: "Build SBOM with Syft"
        run: |
          docker run --rm -v $(pwd):/app anchore/syft dir:/app -o cyclonedx-json=/app/reports/sbom.json

      - name: "Scan SBOM with Trivy"
        run: |
          docker run --rm -v $(pwd):/app aquasecurity/trivy sbom /app/reports/sbom.json > /app/reports/trivy-sbom.txt

      - name: "Run OWASP Dependency-Check"
        run: |
          docker run --rm -v $(pwd)/app:/project owasp/dependency-check \
            --project juice-shop \
            --scan /project/node_modules \
            --format XML \
            --out /project/reports/

      - name: "Static analysis with SonarQube"
        run: |
          docker run --rm -v $(pwd)/app:/src sonarsource/sonar-scanner-cli \
            -Dsonar.organization=${{ env.SONAR_ORG }} \
            -Dsonar.projectKey=${{ env.PROJECT_KEY }} \
            -Dsonar.sources=/src \
            -Dsonar.host.url=https://sonarcloud.io 

      - name: "Dynamic analysis with OWASP ZAP"
        run: |
          docker run --rm -v $(pwd)/reports:/zap/reports owasp/zap2docker-stable zap-baseline.py -t http://juice-shop:3000 -r zap-report.html

      - name: "Upload reports"
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: security-reports
          path: reports/