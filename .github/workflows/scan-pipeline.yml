name: Security Scan Pipeline

on:
  push:
    branches-ignore:
      - l10n_develop
      - gh-pages
    tags-ignore:
      - '*'
  pull_request:
    types:
      - opened
      - synchronize

env:
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  SONAR_ORG: your_organization_key
  PROJECT_KEY: juice-shop-devsecops

jobs:
  security-check:
    runs-on: ubuntu-latest

    services:
      juice-shop:
        image: bkimminich/juice-shop
        ports:
          - "3000:3000"

    steps:
      - name: "Checkout OWASP Juice Shop"
        uses: actions/checkout@v4
        with:
          repository: owasp-juice-shop/juice-shop
          ref: master
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: "Run Gitleaks scan"
        run: |
          docker run --rm -v $(pwd):/src ghcr.io/gitleaks/gitleaks detect --source /src --no-git --no-error

      - name: "Build SBOM with Syft"
        run: |
          docker run --rm -v $(pwd):/app anchore/syft dir:/app -o cyclonedx-json=/app/reports/sbom.json

      - name: "Scan SBOM with Trivy"
        run: |
          docker run --rm -v $(pwd):/app aquasecurity/trivy sbom /app/reports/sbom.json > /app/reports/trivy-sbom.txt

      - name: "Run OWASP Dependency-Check"
        run: |
          docker run --rm -v $(pwd):/project owasp/dependency-check \
            --project juice-shop \
            --scan /project/node_modules \
            --format XML \
            --out /project/reports/

      - name: "Static analysis with SonarQube"
        run: |
          docker run --rm -v $(pwd):/src sonarsource/sonar-scanner-cli \
            -Dsonar.organization=${{ env.SONAR_ORG }} \
            -Dsonar.projectKey=${{ env.PROJECT_KEY }} \
            -Dsonar.sources=/src \
            -Dsonar.host.url=https://sonarcloud.io    

      - name: "Dynamic analysis with OWASP ZAP"
        run: |
          docker run --rm -v $(pwd)/reports:/zap/reports owasp/zap2docker-stable zap-baseline.py -t http://juice-shop:3000 -r zap-report.html

      - name: "Upload reports"
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/